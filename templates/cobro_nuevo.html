{% extends "base.html" %}
{% block title %}Nuevo Cobro{% endblock %}
{% block content %}
<h2>Nuevo Cobro</h2>
<p><strong>Usuario:</strong> {{ request.user.username }}</p>
<p><strong>Caja abierta desde:</strong> {{ caja.fecha_apertura }}</p>

<form method="post" id="formCobro">
  {% csrf_token %}
  {{ form.non_field_errors }}
  <div class="mb-3">
    <div class="mb-3">
      <label for="id_dni" class="form-label">DNI del Cliente</label>
      <input type="text" id="id_dni" name="dni" class="form-control" placeholder="Ingrese DNI...">
      <ul id="resultadosDNI" class="list-group position-absolute w-50"></ul>
    </div>
  </div>
        <!-- Método de pago -->
        <div class="mb-3">
          {{ form.metodo_pago.label_tag }} {{ form.metodo_pago }}
        </div>
        <div class="mb-3">
          {{ form.servicio.label_tag }} {{ form.servicio }}           <p>^^^ MODIFICAR SOLO SI EL CLIENTE LO SOLICITA ^^^</p>

        </div>
        <!-- Descripción -->
        <div class="mb-3">
          {{ form.descripcion.label_tag }} {{ form.descripcion }}
        </div>

        <!-- Botones -->
        <button type="button" class="btn btn-success" id="btnPagar">Registrar Cobro</button>
        <a href="{% url 'cobros_lista' %}" class="btn btn-danger">Cancelar</a>
      </form>
    </div>
  </div>
</div>

<!-- Modal Efectivo -->
<div class="modal fade" id="modalEfectivo" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header border-bordo">
        <h5 class="modal-title">Confirmar Pago en Efectivo</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        ¿Se recibió el pago en efectivo?
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-success" form="formCobro">Sí, confirmar</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No se realizó</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Transferencia -->
<div class="modal fade" id="modalTransferencia" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header border-bordo">
        <h5 class="modal-title">Pago por Transferencia</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <p>Escanee el QR o use el alias:</p>
        <img src="{'#'}" alt="QR Transferencia" class="img-fluid mb-3">
        <p><strong>Alias:</strong> gimnasio.atleticx</p>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-success" form="formCobro">Confirmar Pago</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
      </div>
    </div>
  </div>
</div>

<script>
document.getElementById("btnPagar").addEventListener("click", function() {
  const metodo = document.getElementById("id_metodo_pago").value;
  if (metodo) {
    const texto = document.getElementById("id_metodo_pago").options[document.getElementById("id_metodo_pago").selectedIndex].text;
    if (texto.toLowerCase().includes("efectivo")) {
      new bootstrap.Modal(document.getElementById("modalEfectivo")).show();
    } else {
      new bootstrap.Modal(document.getElementById("modalTransferencia")).show();
    }
  }
});
</script>
 
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
  const input = document.getElementById("id_dni");
  const resultados = document.getElementById("resultadosDNI");

  input.addEventListener("keyup", function() {
    let query = this.value;
    if (query.length > 0) {
      fetch(`/cobros/buscar-dni/?q=${query}`)
        .then(response => response.json())
        .then(data => {
          resultados.innerHTML = "";
          data.forEach(item => {
            let li = document.createElement("li");
            li.classList.add("list-group-item", "list-group-item-action");
            li.textContent = `${item.dni} - ${item.nombre}`;
            li.addEventListener("click", function() {
              input.value = item.dni;   // autocompleta el input
              resultados.innerHTML = ""; // limpia la lista
            });
            resultados.appendChild(li);
          });
        });
    } else {
      resultados.innerHTML = "";
    }
  });
});
</script>
<script>
document.addEventListener("DOMContentLoaded", function() {
  const input = document.getElementById("id_dni");
  const resultados = document.getElementById("resultadosDNI");

  input.addEventListener("keyup", function() {
    let query = this.value;
    if (query.length > 0) {
      fetch(`/cobros/buscar-dni/?q=${query}`)
        .then(response => response.json())
        .then(data => {
          resultados.innerHTML = "";
          data.forEach(item => {
            let li = document.createElement("li");
            li.classList.add("list-group-item", "list-group-item-action");
            li.textContent = `${item.dni} - ${item.nombre}`;
            li.addEventListener("click", function() {
              input.value = item.dni;   // autocompleta el input
              resultados.innerHTML = ""; // limpia la lista
            });
            resultados.appendChild(li);
          });
        });
    } else {
      resultados.innerHTML = "";
    }
  });
});
</script>

{% endblock %}
