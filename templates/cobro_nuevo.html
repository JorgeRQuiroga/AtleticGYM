{% extends "base.html" %}
{% block title %}Nuevo Cobro{% endblock %}
{% block content %}
<h2>Nuevo Cobro</h2>
<p><strong>Usuario:</strong> {{ request.user.username }}</p>
<p><strong>Caja abierta desde:</strong> {{ caja.fecha_apertura }}</p>

<form method="post">
  {% csrf_token %}
  {{ form.non_field_errors }}
  <div class="mb-3">
    <div class="mb-3">
      <label for="id_dni" class="form-label">DNI del Cliente</label>
      <input type="text" id="id_dni" name="dni" class="form-control" placeholder="Ingrese DNI...">
      <ul id="resultadosDNI" class="list-group position-absolute w-50"></ul>
    </div>
  </div>
  <div class="mb-3">
    {{ form.servicio.label_tag }} {{ form.servicio }} {{ form.servicio.errors }}
  </div>
  <div class="mb-3">
    {{ form.descripcion.label_tag }} {{ form.descripcion }} {{ form.descripcion.errors }}
  </div>
  <button class="btn btn-primary" type="submit">Registrar cobro</button>
  <a class="btn btn-danger " href="{% url 'cobros_lista' %}">Cancelar</a>
</form>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
  const input = document.getElementById("id_dni");
  const resultados = document.getElementById("resultadosDNI");

  input.addEventListener("keyup", function() {
    let query = this.value;
    if (query.length > 0) {
      fetch(`/cobros/buscar-dni/?q=${query}`)
        .then(response => response.json())
        .then(data => {
          resultados.innerHTML = "";
          data.forEach(item => {
            let li = document.createElement("li");
            li.classList.add("list-group-item", "list-group-item-action");
            li.textContent = `${item.dni} - ${item.nombre}`;
            li.addEventListener("click", function() {
              input.value = item.dni;   // autocompleta el input
              resultados.innerHTML = ""; // limpia la lista
            });
            resultados.appendChild(li);
          });
        });
    } else {
      resultados.innerHTML = "";
    }
  });
});
</script>
<script>
document.addEventListener("DOMContentLoaded", function() {
  const input = document.getElementById("id_dni");
  const resultados = document.getElementById("resultadosDNI");

  input.addEventListener("keyup", function() {
    let query = this.value;
    if (query.length > 0) {
      fetch(`/cobros/buscar-dni/?q=${query}`)
        .then(response => response.json())
        .then(data => {
          resultados.innerHTML = "";
          data.forEach(item => {
            let li = document.createElement("li");
            li.classList.add("list-group-item", "list-group-item-action");
            li.textContent = `${item.dni} - ${item.nombre}`;
            li.addEventListener("click", function() {
              input.value = item.dni;   // autocompleta el input
              resultados.innerHTML = ""; // limpia la lista
            });
            resultados.appendChild(li);
          });
        });
    } else {
      resultados.innerHTML = "";
    }
  });
});
</script>

{% endblock %}
