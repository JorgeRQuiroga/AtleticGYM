{% extends "base.html" %}
{% load static %}
{% block title %}Nuevo Cobro{% endblock %}

{% block content %}
<div class="container py-4">

  <!-- Encabezado -->
  <div class="text-center mb-4">
    <h1 class="fw-bold text-danger">
      <i class="bi bi-plus-circle me-2"></i> Nuevo Cobro
    </h1>
    <p class="text-light mb-1">Registrar cobro rápido desde la caja activa</p>
    <div class="small text-muted">
      <span class="me-3"><strong class="text-light">Usuario:</strong> {{ request.user.username }}</span>
      <span><strong class="text-light">Caja abierta desde:</strong> {{ caja.fecha_apertura }}</span>
    </div>
  </div>

  <!-- Formulario -->
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <form method="post" id="formCobro" class="card bg-dark text-light shadow-sm border-0 p-4">
        {% csrf_token %}
        {{ form.non_field_errors }}

        <div class="row g-3">

          <!-- DNI con autocompletado -->
          <div class="col-12 position-relative">
            <label for="id_dni" class="form-label text-danger">DNI del Cliente</label>
            <div class="input-group">
              <input type="text" id="id_dni" name="dni" class="form-control bg-opacity-10" placeholder="Ingrese DNI..." autocomplete="off">
              <button type="button" class="btn btn-outline-light" id="btnBuscarCliente" title="Buscar cliente">
                <i class="bi bi-search"></i>
              </button>
            </div>
            <div class="form-text text-muted small">Escriba al menos 2 dígitos para buscar clientes existentes.</div>

            <ul id="resultadosDNI"
                class="list-group position-absolute w-100 mt-1"
                style="z-index:1050; max-height:220px; overflow:auto; display:none;">
            </ul>
          </div>

          <!-- Método de pago -->
          <div class="col-md-6">
            <label class="form-label text-danger">{{ form.metodo_pago.label }}</label>
            {{ form.metodo_pago }}
            {% if form.metodo_pago.errors %}
              <div class="form-text text-danger small">{{ form.metodo_pago.errors|striptags }}</div>
            {% endif %}
          </div>

          <!-- Servicio -->
          <div class="col-md-6">
            <label class="form-label text-danger">{{ form.servicio.label }}</label>
            {{ form.servicio }}
            <div class="form-text text-muted small">Modificar solo si el cliente lo solicita.</div>
            {% if form.servicio.errors %}
              <div class="form-text text-danger small">{{ form.servicio.errors|striptags }}</div>
            {% endif %}
          </div>

          <!-- Descripción -->
          <div class="col-12">
            <label class="form-label text-danger">{{ form.descripcion.label }}</label>
            {{ form.descripcion }}
            {% if form.descripcion.errors %}
              <div class="form-text text-danger small">{{ form.descripcion.errors|striptags }}</div>
            {% endif %}
          </div>

        </div>

        <!-- Botones -->
        <div class="mt-4 d-flex justify-content-end gap-2">
          <button type="button" class="btn btn-success" id="btnPagar">
            <i class="bi bi-check-circle me-1"></i> Registrar Cobro
          </button>
          <a href="{% url 'cobros_lista' %}" class="btn btn-outline-light">
            <i class="bi bi-x-circle me-1"></i> Cancelar
          </a>
        </div>

      </form>
    </div>
  </div>
</div>

{% include 'partials/modal_confimacion_pago.html' %}

<!-- Scripts (sin modificar funcionalidad) -->
<script>
document.getElementById("btnPagar").addEventListener("click", function() {
  const metodo = document.getElementById("id_metodo_pago").value;
  if (metodo) {
    const texto = document.getElementById("id_metodo_pago").options[document.getElementById("id_metodo_pago").selectedIndex].text;
    if (texto.toLowerCase().includes("efectivo")) {
      new bootstrap.Modal(document.getElementById("modalEfectivo")).show();
    } else {
      new bootstrap.Modal(document.getElementById("modalTransferencia")).show();
    }
  }
});
</script>
 
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const input = document.getElementById("id_dni");
  const resultados = document.getElementById("resultadosDNI");

  input.addEventListener("keyup", function() {
    let query = this.value;
    if (query.length > 0) {
      fetch(`/cobros/buscar-dni/?q=${query}`)
        .then(response => response.json())
        .then(data => {
          resultados.innerHTML = "";
          data.forEach(item => {
            let li = document.createElement("li");
            li.classList.add("list-group-item", "list-group-item-action");
            li.textContent = `${item.dni} - ${item.nombre}`;
            li.addEventListener("click", function() {
              input.value = item.dni;   // autocompleta el input
              resultados.innerHTML = ""; // limpia la lista
            });
            resultados.appendChild(li);
          });
          resultados.style.display = data.length ? 'block' : 'none';
        });
    } else {
      resultados.innerHTML = "";
      resultados.style.display = 'none';
    }
  });
});
</script>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const input = document.getElementById("id_dni");
  const resultados = document.getElementById("resultadosDNI");

  input.addEventListener("keyup", function() {
    let query = this.value;
    if (query.length > 0) {
      fetch(`/cobros/buscar-dni/?q=${query}`)
        .then(response => response.json())
        .then(data => {
          resultados.innerHTML = "";
          data.forEach(item => {
            let li = document.createElement("li");
            li.classList.add("list-group-item", "list-group-item-action");
            li.textContent = `${item.dni} - ${item.nombre}`;
            li.addEventListener("click", function() {
              input.value = item.dni;   // autocompleta el input
              resultados.innerHTML = ""; // limpia la lista
            });
            resultados.appendChild(li);
          });
          resultados.style.display = data.length ? 'block' : 'none';
        });
    } else {
      resultados.innerHTML = "";
      resultados.style.display = 'none';
    }
  });
});
</script>

{% endblock %}
