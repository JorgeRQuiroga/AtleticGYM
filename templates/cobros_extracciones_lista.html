{% extends "base.html" %}
{% load static %}
{% block title %}Extracciones de Caja{% endblock %}

{% block content %}
<div class="container py-4">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="fw-bold text-danger mb-0">
      <i class="bi bi-box-arrow-down me-2"></i> Extracciones
    </h1>
    <button class="btn btn-outline-light btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#detallesCaja" aria-expanded="false" aria-controls="detallesCaja">
      <i class="bi bi-cash-coin me-1"></i> Detalles de Caja
    </button>
  </div>

  <!-- Detalles de la caja colapsables -->
  <div class="collapse" id="detallesCaja">
    <div class="card bg-dark text-light border-secondary mb-4">
      <div class="card-body">
        <div class="row gy-2">
          <div class="col-md-3"><span class="text-danger fw-semibold">Usuario:</span> {{ request.user.username }}</div>
          <div class="col-md-3"><span class="text-danger fw-semibold">Apertura:</span> {{ caja.fecha_apertura|date:"d/m/Y H:i" }}</div>
          <div class="col-md-3"><span class="text-danger fw-semibold">Monto inicial:</span> ${{ caja.monto_apertura }}</div>
          <div class="col-md-3">
            <span class="text-danger fw-semibold">Total actual:</span>
            <span class="badge bg-success ms-2 fs-6">${{ caja.total_en_caja }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Botones de acción -->
  {% include "partials/cobros_acciones.html" with active="extracciones" %}
  <hr class="border-secondary">

  <!-- Sección de la lista de extracciones -->
  <div class="container-fluid py-2">

    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4 class="text-danger mb-0">
        <i class="bi bi-list-check me-2"></i> Historial de Extracciones
      </h4>
      <button class="btn btn-sm btn-outline-light" type="button" data-bs-toggle="collapse" data-bs-target="#listaCollapse" aria-expanded="true" aria-controls="listaCollapse">
        <i class="bi bi-eye me-1"></i> Ocultar / Mostrar
      </button>
    </div>

    <!-- Filtros -->
    <form method="get" class="row g-3 align-items-end mb-4">
      <div class="col-md-6">
        <div class="input-group">
          <span class="input-group-text bg-secondary text-light"><i class="bi bi-search"></i></span>
          <input type="text" name="q" value="{{ query|default:'' }}" class="form-control" placeholder="Buscar por usuario, apellido o DNI">
        </div>
      </div>

      <div class="col-md-3">
        <select name="orden" class="form-select">
          <option value="">-- Ordenar por --</option>
          <option value="fecha_desc" {% if orden == 'fecha_desc' %}selected{% endif %}>Fecha ↓</option>
          <option value="fecha_asc" {% if orden == 'fecha_asc' %}selected{% endif %}>Fecha ↑</option>
          <option value="monto_desc" {% if orden == 'monto_desc' %}selected{% endif %}>Monto ↓</option>
          <option value="monto_asc" {% if orden == 'monto_asc' %}selected{% endif %}>Monto ↑</option>
        </select>
      </div>

      <div class="col-md-3 d-flex gap-2">
        <button type="submit" class="btn btn-danger">
          <i class="bi bi-filter me-1"></i> Aplicar
        </button>
        <a href="{% url 'cobros_mostrar_extracciones' %}" class="btn btn-outline-light">
          <i class="bi bi-x-circle me-1"></i> Limpiar
        </a>
      </div>
    </form>

    <!-- Tabla dinámica -->
    <div class="collapse show" id="listaCollapse">
      <div class="table-responsive">
        <table class="table table-hover table-bordered align-middle text-center table-dark shadow-sm mb-0">
          <thead>
            <tr>
              <th class="text-start">Usuario</th>
              <th>DNI</th>
              <th>Monto</th>
              <th class="text-start">Motivo</th>
              <th>Fecha</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody class="text-light">
            {% for e in page_obj %}
              <tr>
                <td class="text-start">{{ e.usuario.last_name }} {{ e.usuario.first_name }}</td>
                <td>
                  {% if e.usuario.empleado %}
                    {{ e.usuario.empleado.dni }}
                  {% else %}
                    <span class="text-muted">-----</span>
                  {% endif %}
                </td>
                <td><span class="badge bg-danger">${{ e.monto }}</span></td>
                <td class="text-start">{{ e.motivo|default:"-" }}</td>
                <td>{{ e.fecha_hora|date:"d/m/Y H:i" }}</td>
                <td>
                  <a href="{% url 'extraccion_detalle' e.pk %}" class="btn btn-outline-info btn-sm">
                    <i class="bi bi-eye"></i> Ver
                  </a>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="6" class="text-center text-muted">No hay extracciones registradas en esta caja.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Paginación -->
      {% if page_obj.has_other_pages %}
        <nav aria-label="Paginación de extracciones" class="mt-3">
          <ul class="pagination justify-content-center">
            {% for num in page_obj.paginator.page_range %}
              <li class="page-item {% if num == page_obj.number %}active{% endif %}">
                <a class="page-link"
                  href="?page={{ num }}{% if query %}&q={{ query }}{% endif %}{% if orden %}&orden={{ orden }}{% endif %}">
                  {{ num }}
                </a>
              </li>
            {% endfor %}
          </ul>
        </nav>
      {% endif %}

        </ul>
      </nav>
    </div>
  </div>

  <!-- Modal Inscripción -->
  {% include 'partials/modal_agregar_mem.html' %}

  <!-- Modal de decisión -->
  <div class="modal fade" id="modalDecision" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content bg-dark text-light">
        <div class="modal-header border-secondary">
          <h5 class="modal-title text-danger"><i class="bi bi-question-circle me-2"></i> Tipo de Cobro</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-center">
          <p class="text-light mb-3">¿Qué tipo de cobro desea registrar?</p>
          <a href="{% url 'cobros_un_dia' %}" class="btn btn-outline-info me-2">Por día de clase</a>
          <a href="{% url 'cobros_nuevo' %}" class="btn btn-outline-success">Cliente con membresía</a>
        </div>
      </div>
    </div>
  </div>

</div>
{% endblock %}
