{% extends 'base.html' %}
{% load static %}

{% block content %}
<h1>Registro de Asistencias</h1>

<!-- Botones para elegir tipo de asistencia -->
<div class="mb-3">
  <button type="button"
          class="btn btn-success"
          data-bs-toggle="modal"
          data-bs-target="#modalAsistencia"
          data-url="{% url 'asistencias:asistencia_form' 'cliente' 1 %}">
    Registrar Asistencia Cliente
  </button>

  <button type="button"
          class="btn btn-primary"
          data-bs-toggle="modal"
          data-bs-target="#modalAsistencia"
          data-url="{% url 'asistencias:asistencia_form' 'empleado' 1 %}">
    Registrar Asistencia Empleado
  </button>
</div>

<!-- Modal genérico -->
<div class="modal fade" id="modalAsistencia" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <!-- Aquí se cargará el formulario vía AJAX -->
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function() {
  const modal = document.getElementById('modalAsistencia');

  // Cuando se abre el modal, cargar el formulario desde la URL del botón
  modal.addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;
    const url = button.getAttribute('data-url');

    fetch(url)
      .then(response => response.json())
      .then(data => {
        modal.querySelector('.modal-content').innerHTML = data.html_form;

        // Manejar envío del formulario
        const form = modal.querySelector('#asistenciaForm');
        form.addEventListener('submit', function(e) {
          e.preventDefault();
          fetch(form.action, {
            method: "POST",
            body: new FormData(form),
            headers: { "X-Requested-With": "XMLHttpRequest" }
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              const bsModal = bootstrap.Modal.getInstance(modal);
              bsModal.hide();
              location.reload(); // refresca la lista de asistencias
            } else {
              if (data.html_form) {
                modal.querySelector('.modal-content').innerHTML = data.html_form;
              } else if (data.error) {
                alert(data.error);
              }
            }
          });
        });
      });
  });
});
</script>
{% endblock %}
