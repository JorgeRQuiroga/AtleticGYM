{% extends 'base.html' %}
{% load static %}

{% block title %}Membresías{% endblock %}

{% block content %}
<div class="container-fluid py-4">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="fw-bold text-danger mb-0">
      <i class="bi bi-people-fill me-2"></i> Membresías
    </h1>

    <!-- Botones alineados a la derecha -->
    <div class="d-flex gap-2">
      <!-- Botón que abre el modal -->
      <button class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#modalInscripcion">
        <i class="bi bi-person-plus me-1"></i> Inscribir Cliente
      </button>
      <!-- Botón para volver al menú de membresías -->
      <a href="{% url 'membresias:membresias_menu' %}" class="btn btn-outline-light fw-bold">
        <i class="bi bi-arrow-left-circle me-1"></i> Volver al Menú
      </a>
    </div>
  </div>

  <!-- Card contenedor -->
  <div class="card bg-dark text-light shadow-sm mb-4 border-secondary">
    <div class="card-body">

      <!-- Formulario de búsqueda -->
      <form method="get" class="row g-3 align-items-end mb-3">
        <div class="col-md-4">
          <div class="input-group">
            <span class="input-group-text bg-secondary text-light"><i class="bi bi-search"></i></span>
            <input type="text" name="q" value="{{ query|default_if_none:'' }}" 
                   class="form-control text-light" placeholder="Buscar por DNI o nombre/apellido" aria-label="Buscar membresías">
          </div>
        </div>

        <div class="col-md-4">
          <select name="orden" class="form-select bg-transparent text-light">
            <option value="">-- Ordenar / Filtrar --</option>
            <option value="fecha_asc" {% if orden == 'fecha_asc' %}selected{% endif %}>Inscripción ↑</option>
            <option value="fecha_desc" {% if orden == 'fecha_desc' %}selected{% endif %}>Inscripción ↓</option>
            <option value="nombre_asc" {% if orden == 'nombre_asc' %}selected{% endif %}>Nombre ↑</option>
            <option value="nombre_desc" {% if orden == 'nombre_desc' %}selected{% endif %}>Nombre ↓</option>
            <option value="dni_asc" {% if orden == 'dni_asc' %}selected{% endif %}>DNI ↑</option>
            <option value="dni_desc" {% if orden == 'dni_desc' %}selected{% endif %}>DNI ↓</option>
            <option value="solo_activo" {% if orden == 'solo_activo' %}selected{% endif %}>Solo Activas</option>
            <option value="solo_inactivo" {% if orden == 'solo_inactivo' %}selected{% endif %}>Solo Inactivas</option>
          </select>
        </div>

        <div class="col-md-4 d-flex gap-2">
          <button type="submit" class="btn btn-danger flex-fill">
            <i class="bi bi-filter me-1"></i> Aplicar
          </button>
          <a href="{% url 'membresias:membresias_lista' %}" class="btn btn-outline-light flex-fill">
            <i class="bi bi-x-circle me-1"></i> Limpiar
          </a>
        </div>
      </form>

      <!-- Tabla -->
      <div class="table-responsive">
        <table class="table table-hover table-bordered align-middle text-center table-dark mb-0" id="tablaMembresias">
          <thead>
            <tr>
              <th class="text-center">Estado</th>
              <th class="text-start">Cliente</th>
              <th>DNI</th>
              <th class="text-start">Servicio</th>
              <th>Vencimiento</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody class="text-light">
            {% for m in page_obj %}
              <tr>
                <td class="text-center">
                  {% if m.activa %}
                    <span class="badge bg-success">Activa</span>
                  {% else %}
                    <span class="badge bg-secondary">Inactiva</span>
                  {% endif %}
                </td>

                <td class="text-start">{{ m.cliente.apellido }}, {{ m.cliente.nombre }}</td>
                <td>{{ m.cliente.dni }}</td>
                <td class="text-start">{{ m.servicio.nombre }}</td>
                <td>{{ m.fecha_fin }}</td>

                <td>
                  <a href="{% url 'membresias:membresias_detalle' m.id %}" class="btn btn-outline-info btn-sm me-1">
                    <i class="bi bi-eye"></i> Ver
                  </a>

                  {% if m.activa %}
                    <button class="btn btn-outline-danger btn-sm" data-bs-toggle="modal" data-bs-target="#confirmarEliminar{{ m.id }}">
                      <i class="bi bi-trash-fill me-1"></i> Eliminar
                    </button>
                  {% else %}
                    <button class="btn btn-secondary btn-sm" disabled>
                      <i class="bi bi-trash-fill me-1"></i> Eliminar
                    </button>
                  {% endif %}
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="6" class="text-center text-muted">No hay membresías registradas.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>

        <!-- Paginación -->
        {% if page_obj.has_other_pages %}
        <nav aria-label="Paginación de empleados">
          <ul class="pagination justify-content-center">
            {% for num in page_obj.paginator.page_range %}
              <li class="page-item {% if num == page_obj.number %}active{% endif %}">
                <a class="page-link" href="?page={{ num }}{% if query %}&q={{ query }}{% endif %}{% if orden %}&orden={{ orden }}{% endif %}">
                  {{ num }}
                </a>
              </li>
            {% endfor %}
          </ul>
        </nav>
        {% endif %}
    </div>
  </div>
</div>

<!-- Modales fuera de la tabla -->
{% for m in page_obj %}
  {% if m.activa %}
    {% include 'partials/modal_eliminacion_mem.html' %}
  {% endif %}
{% endfor %}

{% include 'partials/modal_agregar_mem.html' %}
{% endblock %}

{% block extra_styles %}
{% endblock %}
