{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid py-4">
  <h1 class="mb-4">Membresías</h1>

  <!-- Botón que abre el modal -->
  <button class="btn btn-primary mb-4" data-bs-toggle="modal" data-bs-target="#modalInscripcion">
    + Inscribir Cliente
  </button>

  <!-- Card contenedor -->
  <div class="card bg-dark text-light shadow-sm mb-4">
    <div class="card-body">
      <!-- Formulario de búsqueda -->
      <form method="get" class="row g-3 align-items-end mb-3">
        <div class="col-md-4">
          <input type="text" name="q" value="{{ query|default_if_none:''}}" 
                 class="form-control" placeholder="Buscar por DNI o nombre/apellido">
        </div>
        <div class="col-md-4">
          <select name="orden" class="form-select">
            <option value="">-- Ordenar / Filtrar --</option>
            <option value="fecha_asc" {% if orden == 'fecha_asc' %}selected{% endif %}>Inscripción: Antiguo → Nuevo</option>
            <option value="fecha_desc" {% if orden == 'fecha_desc' %}selected{% endif %}>Inscripción: Nuevo → Antiguo</option>
            <option value="nombre_asc" {% if orden == 'nombre_asc' %}selected{% endif %}>Nombre: A → Z</option>
            <option value="nombre_desc" {% if orden == 'nombre_desc' %}selected{% endif %}>Nombre: Z → A</option>
            <option value="dni_asc" {% if orden == 'dni_asc' %}selected{% endif %}>DNI: Menor → Mayor</option>
            <option value="dni_desc" {% if orden == 'dni_desc' %}selected{% endif %}>DNI: Mayor → Menor</option>
            <option value="solo_activo" {% if orden == 'solo_activo' %}selected{% endif %}>Solo Activas</option>
            <option value="solo_inactivo" {% if orden == 'solo_inactivo' %}selected{% endif %}>Solo Inactivas</option>
          </select>
        </div>
        <div class="col-md-4 d-flex gap-2">
          <button type="submit" class="btn btn-primary flex-fill">Aplicar</button>
          <a href="{% url 'membresias:membresias_lista' %}" class="btn btn-secondary flex-fill">Limpiar</a>
        </div>
      </form>

      <!-- Tabla -->
      <div class="table-responsive">
        <table class="table table-hover table-bordered align-middle text-center table-dark mb-0" id="tablaMembresias">
          <thead>
            <tr>
              <th>Estado</th>
              <th>Cliente</th>
              <th>DNI</th>
              <th>Servicio</th>
              <th>Vencimiento</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for m in page_obj %}
              <tr>
                <td>
                  {% if m.activa %}
                    <span class="badge bg-success">Activa</span>
                  {% else %}
                    <span class="badge bg-secondary">Inactiva</span>
                  {% endif %}
                </td>
                <td>{{ m.cliente.apellido }}, {{ m.cliente.nombre }}</td>
                <td>{{ m.cliente.dni }}</td>
                <td>{{ m.servicio.nombre }}</td>
                <td>{{ m.fecha_fin }}</td>
                <td>
                  <a href="{% url 'membresias:membresias_detalle' m.id %}" class="btn btn-info btn-sm">Ver</a>
                  {% if m.activa %}
                    <button class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#confirmarEliminar{{ m.id }}">
                      <i class="bi bi-trash-fill me-1"></i> Eliminar
                    </button>
                  {% else %}
                    <button class="btn btn-secondary btn-sm" disabled>
                      <i class="bi bi-trash-fill me-1"></i> Eliminar
                    </button>
                  {% endif %}
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="6" class="text-center">No hay membresías registradas.</td></tr>
            {% endfor %}
          </tbody>
        </table>

        <!-- Paginador -->
        <nav aria-label="Page navigation" class="mt-3">
          <ul class="pagination justify-content-center custom-pagination">
            {% if page_obj.has_previous %}
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}&q={{ query|urlencode }}&orden={{ orden|default_if_none:'' }}">Anterior</a>
              </li>
            {% endif %}

            <li class="page-item disabled">
              <span class="page-link">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
            </li>

            {% if page_obj.has_next %}
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}&q={{ query|urlencode }}&orden={{ orden|default_if_none:'' }}">Siguiente</a>
              </li>
            {% endif %}
          </ul>
        </nav>
      </div>
    </div>
  </div>
</div>

<!-- Modales fuera de la tabla (solo para las visibles en la página actual) -->
{% for m in page_obj %}
  {% if m.activa %}
    <div class="modal fade" id="confirmarEliminar{{ m.id }}" tabindex="-1" aria-labelledby="modalLabel{{ m.id }}" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
          <div class="modal-header border-secondary">
            <h5 class="modal-title text-danger fw-bold" id="modalLabel{{ m.id }}">
              <i class="bi bi-exclamation-triangle-fill me-2"></i> Confirmar Eliminación
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p class="mb-0">
              ¿Seguro que deseas eliminar la membresía de 
              <strong class="text-warning">{{ m.cliente.apellido }}, {{ m.cliente.nombre }}</strong>?
            </p>
          </div>
          <div class="modal-footer border-secondary">
            <form method="post" action="{% url 'membresias:membresia_borrar' m.id %}">
              {% csrf_token %}
              <button type="submit" class="btn btn-danger fw-bold">
                <i class="bi bi-trash-fill me-1"></i> Sí, eliminar
              </button>
            </form>
            <button type="button" class="btn btn-secondary fw-bold" data-bs-dismiss="modal">
              <i class="bi bi-x-circle me-1"></i> Cancelar
            </button>
          </div>
        </div>
      </div>
    </div>
  {% endif %}
{% endfor %}

<!-- Modal Inscripción -->
<div class="modal fade" id="modalInscripcion" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header border-bordo">
      {% if editar %}
        <h5 class="modal-title text-primary">Editar Cliente</h5>
      {% else %}
        <h5 class="modal-title text-primary">Inscribir Cliente</h5>
      {% endif %}
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <form method="post" action="{% url 'membresias:membresias_inscribir' %}">
        {% csrf_token %}
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">{{ form.nombre.label_tag }} {{ form.nombre }}</div>
            <div class="col-md-6">{{ form.apellido.label_tag }} {{ form.apellido }}</div>
            <div class="col-md-6">{{ form.dni.label_tag }} {{ form.dni }}</div>
            <div class="col-md-6">{{ form.telefono.label_tag }} {{ form.telefono }}</div>
            <div class="col-md-6">{{ form.emergencia.label_tag }} {{ form.emergencia }}</div>
            <div class="col-md-6">{{ form.domicilio.label_tag }} {{ form.domicilio }}</div>
            <div class="col-md-6">{{ form.email.label_tag }} {{ form.email }}</div>
            <div class="col-md-6">{{ form.servicio.label_tag }} {{ form.servicio }}</div>
            <div class="col-12">{{ form.observaciones.label_tag }} {{ form.observaciones }}</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Guardar</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}
